@app.route("/", methods=["GET", "POST"])
def index():

    # If not logged in â†’ go to login
    if "user" not in session:
        return redirect("/login")

    # Make sure chat exists
    if "chat" not in session:
        session["chat"] = []

    if request.method == "POST":
        expression = request.form.get("expression")

        if expression:
            answer = solve_math(expression)

            # IMPORTANT FIX: re-assign session
            chat = session.get("chat", [])
            chat.append({
                "user": expression,
                "bot": answer
            })

            session["chat"] = chat   # <-- THIS FIXES 400 ERROR

    return render_template(
        "index.html",
        chat=session.get("chat", []),
        user=session.get("user"),
        t=t
    )
